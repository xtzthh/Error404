<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="google" content="notranslate" />
  <title>AgriShield ‚Äî Warehouse</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <style>
    :root { --accent: var(--neon-green); }
    body { background: var(--cyber-black); color: var(--text-primary); }
    .grid-layout { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    .sidebar-hud { background: rgba(5, 7, 10, 0.95); backdrop-filter: blur(20px); border-right: 1px solid var(--cyber-border); padding: 30px; display: flex; flex-direction: column; justify-content: space-between; height: 100vh; position: sticky; top: 0; }
    .main-content { padding: 30px; }
    .warehouse-wrap { padding: 28px; }
    .warehouse-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(220px, 1fr));
      gap: 28px;
      margin-top: 20px;
      padding: 28px;
      background: rgba(0, 255, 136, 0.03);
      border: 1px solid var(--cyber-border);
    }
    .warehouse-block {
      min-height: 210px;
      border: 1px solid var(--cyber-border);
      background: var(--cyber-card-bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      transition: all 0.25s ease;
      cursor: default;
    }

    .warehouse-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 16px rgba(0, 255, 136, 0.12);
    }
    .warehouse-block.vacant { border-color: var(--cyber-border); }
    .warehouse-block.safe {
      border-color: var(--neon-green);
      box-shadow: 0 0 12px rgba(0, 255, 136, 0.12);
    }
    .warehouse-block.warning {
      border-color: #ff9f1a;
      box-shadow: 0 0 14px rgba(255, 159, 26, 0.18);
    }
    .warehouse-block.risk {
      border-color: #ff4444;
      box-shadow: 0 0 14px rgba(255, 68, 68, 0.2);
    }
    .warehouse-block.live-pulse::after {
      content: "LIVE";
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--neon-green);
      color: var(--cyber-black);
      font-size: 8px;
      font-weight: 900;
      padding: 2px 5px;
      border-radius: 2px;
      animation: live-blink 1.5s infinite;
    }
    @keyframes live-blink {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.95); }
    }
    .block-id { font-size: 30px; font-weight: 900; color: var(--text-primary); font-family: 'Roboto Mono', monospace; }
    .block-status { margin-top: 10px; font-size: 20px; font-weight: 900; color: var(--text-muted); letter-spacing: 1px; }
    .block-status.safe { color: var(--neon-green); }
    .block-status.warning { color: #ffb347; }
    .block-status.risk { color: #ff4444; }
    .block-tooltip {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%) translateY(6px);
      min-width: 220px;
      padding: 12px;
      border: 1px solid var(--neon-green);
      background: var(--overlay-bg);
      font-family: 'Roboto Mono', monospace;
      font-size: 11px;
      line-height: 1.5;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
      z-index: 20;
    }
    .warehouse-block:hover .block-tooltip { opacity: 1; transform: translateX(-50%) translateY(0); }
    .top-metrics { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 12px; margin-top: 16px; }
    .kpi-metrics { display: grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap: 12px; margin-top: 12px; }
    .metric-box { padding: 14px; border: 1px solid var(--cyber-border); background: rgba(0, 255, 136, 0.02); }
    .metric-value { font-size: 22px; font-weight: 900; color: var(--neon-green); font-family: 'Roboto Mono', monospace; }
    #nearExpiryCount { color: #ffb347; text-shadow: 0 0 8px rgba(255, 159, 26, 0.35); }
    #expiredCount { color: #ff4444; text-shadow: 0 0 8px rgba(255, 68, 68, 0.35); }
    .metric-label { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
    @media (max-width: 1200px) {
      .warehouse-grid { grid-template-columns: repeat(2, minmax(210px, 1fr)); }
      .top-metrics { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
      .kpi-metrics { grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    }
    @media (max-width: 900px) {
      .grid-layout { grid-template-columns: 1fr; }
      .sidebar-hud { display: none; }
      .warehouse-grid { grid-template-columns: 1fr; }
    }
    </style>
</head>
<body>
  <div class="mesh-bg"></div>
  <div class="scanlines"></div>

  <div class="grid-layout">
    <aside class="sidebar-hud">
      <div>
        <div class="brand"><div class="logo-square">AS</div> AGRITECH</div>
        <p class="military-tag" style="margin-top:10px; color: var(--neon-green)">[ WAREHOUSE_ACTIVE ]</p>
        <nav style="margin-top: 40px; display: flex; flex-direction: column; gap: 5px;">
          <a href="landing.html" class="nav-item"><span>üè†</span> HOME_TERMINAL</a>
          <a href="index.html" class="nav-item"><span>üìä</span> INDOOR_DASHBOARD</a>
          <a
          <a href="agri-storage.html" class="nav-item"><span>üì¶</span> STORAGE_UNITS</a>
          <a href="warehouse.html" class="nav-item active"><span>üè¨</span> WAREHOUSE</a>
        </nav>
      </div>
      <div class="cyber-card" style="padding: 15px;">
        <div class="corner-br"></div>
        <div class="military-tag" style="font-size: 9px; margin-bottom: 5px;">SYS_TELEMETRY</div>
        <div class="small" style="font-size: 11px;">LAYOUT: BLOCKWISE_3X3<br>SYNC: LOCAL_ONLY + B05_LIVE</div>
      </div>
    </aside>

    <main class="main-content">
      <div class="cyber-card warehouse-wrap">
        <div class="corner-br"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <div>
            <h1 style="margin:0; font-size: 22px;">WAREHOUSE_BLOCK_MAP</h1>
            <p class="military-tag" style="margin:8px 0 0 0;">FULL_VIEW / BLOCKWISE_STORAGE_UNITS</p>
          </div>
          <button class="btn-cyber" id="refreshWarehouseBtn">REFRESH</button>
        </div>

        <div class="top-metrics">
          <div class="metric-box">
            <div id="occupiedCount" class="metric-value">0</div>
            <div class="metric-label">OCCUPIED_BLOCKS</div>
          </div>
          <div class="metric-box">
            <div id="vacantCount" class="metric-value">9</div>
            <div class="metric-label">VACANT_BLOCKS</div>
          </div>
          <div class="metric-box">
            <div id="nearExpiryCount" class="metric-value">0</div>
            <div class="metric-label">WARNING_BLOCKS</div>
          </div>
          <div class="metric-box">
            <div id="expiredCount" class="metric-value">0</div>
            <div class="metric-label">RISK_BLOCKS</div>
          </div>
        </div>
        <div class="kpi-metrics">
          <div class="metric-box">
            <div id="kpiKgSaved" class="metric-value">0</div>
            <div class="metric-label">KG_SAVED_POTENTIAL</div>
          </div>
          <div class="metric-box">
            <div id="kpiLossPrevented" class="metric-value">‚Çπ0</div>
            <div class="metric-label">LOSS_PREVENTED_EST</div>
          </div>
          <div class="metric-box">
            <div id="kpiLotsRescued" class="metric-value">0</div>
            <div class="metric-label">LOTS_RESCUED</div>
          </div>
        </div>

        <div id="warehouseGrid" class="warehouse-grid"></div>
      </div>
    </main>
  </div>
    
  <script>
    const STORAGE_KEY = 'agri_storage_app_v2_hud';
    const LIVE_BLOCK_KEY = 'agri_live_block_b05';
    const RDE_KEY = 'agri_rde_decisions_v1';
    const RDE_KPI_KEY = 'agri_rde_kpis_v1';
    const BLOCK_TWIN_KEY = 'agri_block_twin_v1';
    const LIVE_CHANNEL_ID = '3214038';
    const LIVE_READ_KEY = 'XIZY6ZXHB5VCKY2T';
    let inventory = [];

    const daysBetween = (a, b) => Math.ceil((b - a) / (1000 * 60 * 60 * 24));
    const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase() : 'N/A';

    function computeHealthScore(daysLeft) {
      if (!Number.isFinite(daysLeft)) return 50;
      if (daysLeft < 0) return 10;
      if (daysLeft <= 15) return 35;
      if (daysLeft <= 30) return 60;
      if (daysLeft <= 90) return 82;
      return 94;
    }
    const CROP_PROFILES = {
      RICE: { tempWarn: 33, tempRisk: 36, humWarn: 78, humRisk: 86, co2Warn: 900, co2Risk: 1200 },
      WHEAT: { tempWarn: 30, tempRisk: 34, humWarn: 70, humRisk: 80, co2Warn: 900, co2Risk: 1200 },
      MAIZE: { tempWarn: 32, tempRisk: 36, humWarn: 75, humRisk: 84, co2Warn: 900, co2Risk: 1200 },
      CORN: { tempWarn: 32, tempRisk: 36, humWarn: 75, humRisk: 84, co2Warn: 900, co2Risk: 1200 },
      SOYBEAN: { tempWarn: 30, tempRisk: 34, humWarn: 72, humRisk: 80, co2Warn: 900, co2Risk: 1200 },
      COTTON: { tempWarn: 31, tempRisk: 35, humWarn: 72, humRisk: 82, co2Warn: 900, co2Risk: 1200 },
      DEFAULT: { tempWarn: 32, tempRisk: 36, humWarn: 75, humRisk: 85, co2Warn: 900, co2Risk: 1200 }
    };

    function getCropProfile(name) {
      const upper = String(name || '').toUpperCase();
      for (const key of Object.keys(CROP_PROFILES)) {
        if (key !== 'DEFAULT' && upper.includes(key)) return CROP_PROFILES[key];
      }
      return CROP_PROFILES.DEFAULT;
    }

    function loadLiveBlockSnapshot() {
      try {
        const raw = localStorage.getItem(LIVE_BLOCK_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : null;
      } catch (_) {
        return null;
      }
    }

    function fmt(v, suffix) {
      return Number.isFinite(Number(v)) ? `${Number(v).toFixed(1)}${suffix}` : '--';
    }

    function evaluateBlockRisk(daysLeft, snapshot, cropName) {
      const reasons = [];
      let level = 'safe';

      if (daysLeft < 0) {
        level = 'risk';
        reasons.push('Lot already expired');
      } else if (daysLeft <= 7) {
        level = 'warning';
        reasons.push(`Low shelf life (${daysLeft} day${daysLeft === 1 ? '' : 's'})`);
      }

      const profile = getCropProfile(cropName);
      const t = Number(snapshot?.temperature_c);
      const h = Number(snapshot?.humidity_pct);
      const c = Number(snapshot?.co2_ppm);

      const setRisk = (msg) => {
        level = 'risk';
        reasons.push(msg);
      };
      const setWarn = (msg) => {
        if (level !== 'risk') level = 'warning';
        reasons.push(msg);
      };

      if (Number.isFinite(t) && t >= profile.tempRisk) setRisk(`Temp high (${t.toFixed(1)}C) for ${String(cropName || 'crop').toUpperCase()}`);
      else if (Number.isFinite(t) && t >= profile.tempWarn) setWarn(`Temp elevated (${t.toFixed(1)}C)`);

      if (Number.isFinite(h) && h >= profile.humRisk) setRisk(`Humidity high (${h.toFixed(1)}%)`);
      else if (Number.isFinite(h) && h >= profile.humWarn) setWarn(`Humidity elevated (${h.toFixed(1)}%)`);

      if (Number.isFinite(c) && c >= profile.co2Risk) setRisk(`CO2 high (${c.toFixed(1)} ppm)`);
      else if (Number.isFinite(c) && c >= profile.co2Warn) setWarn(`CO2 elevated (${c.toFixed(1)} ppm)`);

      if (reasons.length === 0) reasons.push('All monitored conditions within safe limits');
      return { level, reasons };
    }

    function renderWarehouseGrid() {
      const grid = document.getElementById('warehouseGrid');
      grid.innerHTML = '';

      let occupied = 0;
      let warningCount = 0;
      let riskCount = 0;

      for (let i = 1; i <= 9; i++) {
        const blockName = `BLOCK_${i.toString().padStart(2, '0')}`;
        const row = inventory.find(it => String(it.location || '').toUpperCase() === blockName && !it.sold);
        const node = document.createElement('div');

        const isLiveBlock = i === 5;
        const live = isLiveBlock ? loadLiveBlockSnapshot() : null;

        if (!row) {
          if (isLiveBlock) {
            const liveEval = evaluateBlockRisk(999, live, 'UNASSIGNED');
            node.className = `warehouse-block live-pulse ${liveEval.level}`;
            node.innerHTML = `
              <div class="block-id">B${i.toString().padStart(2, '0')}</div>
              <div class="block-status ${liveEval.level}">${liveEval.level.toUpperCase()}</div>
              <div class="block-tooltip">
                <div class="military-tag" style="border-bottom:1px solid rgba(0,255,136,0.1); margin-bottom:8px; padding-bottom:4px;">SECTOR_B${i.toString().padStart(2,'0')}_LIVE</div>
                <div style="display:flex; justify-content:space-between;"><span>ASSET:</span> <span style="color:var(--text-muted);">VACANT</span></div>
                <div style="display:flex; justify-content:space-between;"><span>TEMP:</span> <span style="color:var(--neon-green);">${fmt(live?.temperature_c, 'C')}</span></div>
                <div style="display:flex; justify-content:space-between;"><span>HUMIDITY:</span> <span style="color:var(--neon-green);">${fmt(live?.humidity_pct, '%')}</span></div>
                <div style="display:flex; justify-content:space-between;"><span>NH3:</span> <span style="color:var(--neon-green);">${fmt(live?.nh3_ppm, ' ppm')}</span></div>
                <div style="display:flex; justify-content:space-between;"><span>CO2:</span> <span style="color:var(--neon-green);">${fmt(live?.co2_ppm, ' ppm')}</span></div>
                <div style="margin-top:8px; border-top:1px solid rgba(0,255,136,0.05); padding-top:4px; font-size:9px; color:var(--text-muted); font-style:italic;">
                  ${liveEval.reasons.join(' | ')}
                </div>
              </div>
            `;
            if (liveEval.level === 'warning') warningCount += 1;
            if (liveEval.level === 'risk') riskCount += 1;
          } else {
            node.className = 'warehouse-block vacant';
            node.innerHTML = `
              <div class="block-id">B${i.toString().padStart(2, '0')}</div>
              <div class="block-status">VACANT</div>
            `;
          }
          grid.appendChild(node);
          continue;
        }
        occupied += 1;
        const expiryDate = new Date(row.stored_at);
        expiryDate.setMonth(expiryDate.getMonth() + Number(row.shelf_months || 0));
        const daysLeft = daysBetween(new Date(), expiryDate);
        const evalResult = evaluateBlockRisk(daysLeft, live, row.name);
        const status = evalResult.level;
        const health = Math.max(1, computeHealthScore(daysLeft) - (status === 'risk' ? 35 : status === 'warning' ? 15 : 0));
        if (status === 'warning') warningCount += 1;
        if (status === 'risk') riskCount += 1;

        node.className = `warehouse-block ${status} ${isLiveBlock ? 'live-pulse' : ''}`;
        node.innerHTML = `
          <div class="block-id">B${i.toString().padStart(2, '0')}</div>
          <div class="block-status ${status}">${status.toUpperCase()}</div>
          <div class="block-tooltip">
            <div class="military-tag" style="border-bottom:1px solid rgba(0,255,136,0.1); margin-bottom:8px; padding-bottom:4px;">SECTOR_B${i.toString().padStart(2,'0')}${isLiveBlock ? '_LIVE' : ''}</div>
            <div style="display:flex; justify-content:space-between;"><span>ASSET:</span> <span style="color:var(--neon-green);">${row.name || 'UNKNOWN'}</span></div>
            <div style="display:flex; justify-content:space-between;"><span>QTY:</span> <span style="color:var(--neon-green);">${row.qty || 0} ${row.unit || ''}</span></div>
            <div style="display:flex; justify-content:space-between;"><span>EXPIRY:</span> <span style="color:var(--neon-green);">${formatDate(expiryDate)}</span></div>
            <div style="display:flex; justify-content:space-between;"><span>DAYS_LEFT:</span> <span style="color:${daysLeft < 10 ? '#ff4444' : (daysLeft < 30 ? '#ff9f1a' : 'var(--neon-green)')};">${daysLeft}</span></div>
            <div style="display:flex; justify-content:space-between;"><span>TEMP:</span> <span style="color:var(--neon-green);">${fmt(live?.temperature_c, 'C')}</span></div>
            <div style="display:flex; justify-content:space-between;"><span>HUMIDITY:</span> <span style="color:var(--neon-green);">${fmt(live?.humidity_pct, '%')}</span></div>
            <div style="display:flex; justify-content:space-between;"><span>NH3:</span> <span style="color:var(--neon-green);">${fmt(live?.nh3_ppm, ' ppm')}</span></div>
            <div style="display:flex; justify-content:space-between;"><span>CO2:</span> <span style="color:var(--neon-green);">${fmt(live?.co2_ppm, ' ppm')}</span></div>
            <div style="display:flex; justify-content:space-between; margin-top:4px; font-weight:bold;"><span>HEALTH_SCORE:</span> <span style="color:var(--neon-green);">${health}/100</span></div>
            <div style="margin-top:8px; border-top:1px solid rgba(0,255,136,0.05); padding-top:4px; font-size:9px; color:var(--text-muted); font-style:italic;">
              ${evalResult.reasons.join(' | ')}
            </div>
          </div>
        `;
        grid.appendChild(node);
      }

      document.getElementById('occupiedCount').textContent = String(occupied);
      document.getElementById('vacantCount').textContent = String(9 - occupied);
      document.getElementById('nearExpiryCount').textContent = String(warningCount);
      document.getElementById('expiredCount').textContent = String(riskCount);
    }

    function loadFromLocalCache() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
        if (parsed && Array.isArray(parsed.inventory)) return parsed.inventory;
        return [];
      } catch (_) {
        return [];
      }
    }

    async function loadInventory() {
      let loaded = false;
      try {
        const response = await fetch(STORAGE_API);
        if (response.ok) {
          const data = await response.json();
          if (Array.isArray(data)) {
            inventory = data;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            loaded = true;
          }
        }
      } catch (_) {}

      if (loaded && Array.isArray(inventory) && inventory.length === 0) {
        const local = loadFromLocalCache();
        if (Array.isArray(local) && local.length > 0) {
          inventory = local;
        }
      } else if (!loaded) {
        inventory = loadFromLocalCache();
      }
      persistRdeDecisions();
      renderWarehouseGrid();
    }
    function clamp100(v) {
      return Math.max(0, Math.min(100, v));
    }

    function expiryUrgency(daysLeft) {
      if (daysLeft <= 2) return 100;
      if (daysLeft <= 7) return 80;
      if (daysLeft <= 15) return 60;
      if (daysLeft <= 30) return 35;
      return 10;
    }

    // Trained from producer-prices_ind.csv (FAOSTAT India, annual LCU/tonne).
    // These are lightweight model parameters so RDE can run fully offline.
    const MARKET_SIGNAL_MODEL = {
      RICE: {
        latest_year: 2008,
        intercept: -1635792.088757,
        slope_per_year: 821.07929,
        signal_score: 80.2,
        confidence: 0.95,
        trend_annual_pct: 10.72,
        volatility_pct: 21.189
      },
      WHEAT: {
        latest_year: 2008,
        intercept: -848361.91317,
        slope_per_year: 427.393007,
        signal_score: 81.2,
        confidence: 0.95,
        trend_annual_pct: 6.295,
        volatility_pct: 4.862
      },
      MAIZE: {
        latest_year: 2008,
        intercept: -637215.576331,
        slope_per_year: 321.072189,
        signal_score: 76.5,
        confidence: 0.95,
        trend_annual_pct: 7.242,
        volatility_pct: 11.64
      },
      SOYBEAN: {
        latest_year: 2008,
        intercept: -850063.034545,
        slope_per_year: 429.250909,
        signal_score: 74.6,
        confidence: 0.95,
        trend_annual_pct: 5.746,
        volatility_pct: 8.15
      },
      COTTON: {
        latest_year: 2008,
        intercept: -1610461.333136,
        slope_per_year: 815.268935,
        signal_score: 58.7,
        confidence: 0.914,
        trend_annual_pct: 5.151,
        volatility_pct: 22.57
      },
      DEFAULT: {
        latest_year: 2008,
        intercept: 0,
        slope_per_year: 0,
        signal_score: 74.2,
        confidence: 0.65,
        trend_annual_pct: 0,
        volatility_pct: 0
      }
    };
    const MARKET_OPTIONS = [
      { name: 'VADODARA_MANDI', basePrice: 1.0, demand: 72 },
      { name: 'AHMEDABAD_MANDI', basePrice: 1.06, demand: 78 },
      { name: 'SURAT_MANDI', basePrice: 0.98, demand: 65 }
    ];

    const BASE_PRICE_PER_KG = {
      RICE: 32.0,
      WHEAT: 24.5,
      MAIZE: 18.5,
      CORN: 18.5,
      SOYBEAN: 46.0,
      COTTON: 72.0,
      DEFAULT: 24.0
    };

    function getCropSignalDetails(name) {
      const upper = String(name || '').toUpperCase();
      let cropKey = 'DEFAULT';
      for (const key of Object.keys(MARKET_SIGNAL_MODEL)) {
        if (key !== 'DEFAULT' && upper.includes(key)) {
          cropKey = key;
          break;
        }
      }
      // Handle common alias in inventory naming.
      if (cropKey === 'DEFAULT' && upper.includes('CORN')) cropKey = 'MAIZE';

      const model = MARKET_SIGNAL_MODEL[cropKey] || MARKET_SIGNAL_MODEL.DEFAULT;
      const currentYear = new Date().getFullYear();
      const xNow = Math.max(model.latest_year, currentYear);
      const predNow = model.intercept + model.slope_per_year * xNow;
      const predNext = model.intercept + model.slope_per_year * (xNow + 1);
      const momentumPct = predNow > 0 ? ((predNext - predNow) / predNow) * 100 : 0;
      const score = clamp100(model.signal_score + momentumPct * 0.6);

      return {
        score: Number(score.toFixed(1)),
        confidence: Number(model.confidence || 0.65),
        reason: `ML market trend ${cropKey}: annual_trend ${model.trend_annual_pct}% | vol ${model.volatility_pct}% | conf ${Math.round((model.confidence || 0.65) * 100)}%`
      };
    }
    function getBasePricePerKg(name) {
      const upper = String(name || '').toUpperCase();
      for (const key of Object.keys(BASE_PRICE_PER_KG)) {
        if (key !== 'DEFAULT' && upper.includes(key)) return BASE_PRICE_PER_KG[key];
      }
      return BASE_PRICE_PER_KG.DEFAULT;
    }

    function qtyToKg(item) {
      const q = Number(item?.qty || 0);
      const unit = String(item?.unit || 'kg').toLowerCase();
      if (!Number.isFinite(q) || q <= 0) return 0;
      if (unit.includes('quintal')) return q * 100;
      if (unit.includes('tonne') || unit.includes('ton')) return q * 1000;
      if (unit.includes('bag')) return q * 50;
      return q;
    }

    function parseBlockIndex(location) {
      const m = String(location || '').toUpperCase().match(/BLOCK_(\d{1,2})/);
      if (!m) return 5;
      const n = Number.parseInt(m[1], 10);
      return Number.isFinite(n) ? n : 5;
    }

    function travelHours(blockIndex, marketName) {
      const base = marketName === 'VADODARA_MANDI' ? 1.2 : marketName === 'AHMEDABAD_MANDI' ? 3.4 : 4.1;
      const spread = Math.abs(blockIndex - 5) * 0.12;
      return base + spread;
    }

    function spoilageRiskFromEval(level) {
      if (level === 'risk') return 88;
      if (level === 'warning') return 58;
      return 18;
    }

    function getDispatchAction(score) {
      if (score >= 75) return 'DISPATCH_NOW';
      if (score >= 50) return 'DISPATCH_TODAY';
      if (score >= 30) return 'MONITOR_AND_PLAN';
      return 'HOLD';
    }

    function getDispatchWindow(action) {
      if (action === 'DISPATCH_NOW') return '<6H';
      if (action === 'DISPATCH_TODAY') return '<24H';
      if (action === 'MONITOR_AND_PLAN') return '24-48H';
      return 'HOLD_48H+';
    }

    function bestMarketFor(item, marketSignal) {
      const blockIndex = parseBlockIndex(item.location);
      let best = null;
      for (const m of MARKET_OPTIONS) {
        const tHours = travelHours(blockIndex, m.name);
        const travelScore = clamp100(100 - tHours * 12);
        const routeScore = 0.55 * (marketSignal * m.basePrice) + 0.25 * travelScore + 0.20 * m.demand;
        if (!best || routeScore > best.routeScore) {
          best = { market: m.name, routeScore, travelHours: tHours };
        }
      }
      return best;
    }